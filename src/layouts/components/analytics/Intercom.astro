---
import parseTomlToJson from "@/lib/utils/parseTomlToJson";

const config = parseTomlToJson("./src/config/config.toml");
const enableIntercom = config.analytics?.enable_intercom ?? false;
const intercomAppId = config.analytics?.intercom_app_id ?? "";
const shouldLoadIntercom = enableIntercom && intercomAppId;
---

{shouldLoadIntercom && (
  <Fragment>
    <script is:inline>
      window.intercomSettings = {
        api_base: "https://api-iam.intercom.io",
        app_id: "ta88dezl"
      };
    </script>

    <script is:inline>
      (function(){var w=window;var ic=w.Intercom;if(typeof ic==="function"){ic('reattach_activator');ic('update',w.intercomSettings);}else{var d=document;var i=function(){i.c(arguments);};i.q=[];i.c=function(args){i.q.push(args);};w.Intercom=i;var l=function(){var s=d.createElement('script');s.type='text/javascript';s.async=true;s.src='https://widget.intercom.io/widget/ta88dezl';var x=d.getElementsByTagName('script')[0];x.parentNode.insertBefore(s,x);};if(document.readyState==='complete'){l();}else if(w.attachEvent){w.attachEvent('onload',l);}else{w.addEventListener('load',l,false);}}})();
    </script>

    <script is:inline>
      if (typeof document !== 'undefined') {
        document.addEventListener('DOMContentLoaded', function() {
          if (typeof window.Intercom === 'function') {
            var demoButtons = document.querySelectorAll('[href*="demo"], [data-action="demo"], .cta-demo');
            demoButtons.forEach(function(button) {
              button.addEventListener('click', function() {
                window.Intercom('track', 'demo-requested', {
                  source: 'website',
                  page: window.location.pathname,
                  timestamp: new Date().toISOString()
                });
              });
            });

            if (window.location.pathname.includes('/pricing')) {
              window.Intercom('track', 'pricing-page-viewed', {
                plan_type: 'cybersecurity',
                page: window.location.pathname
              });
            }

            var redTeamElements = document.querySelectorAll('[href*="ai-red-team"], [data-service="ai-red-team"]');
            redTeamElements.forEach(function(element) {
              element.addEventListener('click', function() {
                window.Intercom('track', 'ai-red-team-interest', {
                  service: 'AI Red Team',
                  page: window.location.pathname
                });
              });
            });

            var consultationButtons = document.querySelectorAll('[href*="consultation"], [data-action="consultation"]');
            consultationButtons.forEach(function(button) {
              button.addEventListener('click', function() {
                window.Intercom('track', 'security-consultation-requested', {
                  service_type: 'cybersecurity',
                  urgency: 'standard',
                  source: 'website'
                });
              });
            });
          }
        });
      }
    </script>
  </Fragment>
)}

{shouldLoadIntercom && (
  <noscript>
    <p>Para soporte en vivo, por favor habilita JavaScript o cont√°ctanos directamente en <a href="mailto:support@nubesti.com">support@nubesti.com</a></p>
  </noscript>
)}

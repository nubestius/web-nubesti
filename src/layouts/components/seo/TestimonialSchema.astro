---
import { getCollection } from "astro:content";
import parseTomlToJson from "@/lib/utils/parseTomlToJson";

const config = parseTomlToJson("./src/config/config.toml");
const baseUrl = config.site.base_url;

interface TestimonialSchemaProps {
  testimonials?: any[];
  organizationName?: string;
}

const { testimonials, organizationName } = Astro.props as TestimonialSchemaProps;

// Get testimonials from content if not provided
let testimonialData = testimonials;

if (!testimonialData) {
  try {
    // Try to get testimonial data for current language
    const currentLang = Astro.currentLocale || 'english';
    const langFolder = currentLang === 'en' ? 'english' : currentLang;
    
    const testimonialCollection = await getCollection('sections', (entry) => {
      return entry.id.includes(`${langFolder}/testimonial`);
    });
    
    if (testimonialCollection.length > 0) {
      const testimonialPage = testimonialCollection[0];
      testimonialData = testimonialPage.data.list || [];
    }
  } catch (error) {
    console.warn('Could not load testimonial data for schema:', error);
    testimonialData = [];
  }
}

// Fallback testimonials for schema
const defaultTestimonials = [
  {
    content: "The autonomous AI Red Team platform completely transformed our security posture. We now identify and remediate vulnerabilities 10x faster than traditional methods, with zero false positives disrupting our operations.",
    customer: {
      name: "Carlos Rodriguez",
      role: "CISO at Tecnoayudas",
      image: "/images/customers/avatar/1.jpg"
    }
  },
  {
    content: "Our security team was overwhelmed with manual testing until we implemented this AI-powered solution. The MITRE ATT&CK framework integration provides comprehensive coverage we never had before.",
    customer: {
      name: "Miguel Santos", 
      role: "Head of Security at Escala",
      image: "/images/customers/avatar/2.jpg"
    }
  },
  {
    content: "The continuous security testing capabilities have given us confidence in our infrastructure. We catch critical vulnerabilities before they become incidents, saving us millions in potential breach costs.",
    customer: {
      name: "Luis Martinez",
      role: "Security Director at Hostiva", 
      image: "/images/customers/avatar/3.jpg"
    }
  }
];

const allTestimonials = testimonialData && testimonialData.length > 0 ? testimonialData : defaultTestimonials;

// Generate Review Schema for each testimonial
const reviewSchemas = allTestimonials.filter((testimonial: any) => testimonial.enable !== false).slice(0, 10).map((testimonial: any, index: number) => ({
  "@context": "https://schema.org",
  "@type": "Review",
  "@id": `${new URL(Astro.url.pathname, Astro.site).href}#review-${index + 1}`,
  "reviewBody": testimonial.content,
  "datePublished": new Date().toISOString().split('T')[0],
  "author": {
    "@type": "Person",
    "name": testimonial.customer?.name || `Customer ${index + 1}`,
    "jobTitle": testimonial.customer?.role || "Security Professional",
    "image": testimonial.customer?.image ? `${baseUrl}${testimonial.customer.image}` : undefined,
    "worksFor": {
      "@type": "Organization",
      "name": testimonial.customer?.role?.includes('at ') ? 
        testimonial.customer.role.split('at ')[1] : 
        organizationName || "Technology Company"
    }
  },
  "reviewRating": {
    "@type": "Rating",
    "ratingValue": 5,
    "bestRating": 5,
    "worstRating": 1
  },
  "itemReviewed": {
    "@type": "SoftwareApplication",
    "name": "Nubesti AI Red Team Platform",
    "description": "AI-powered autonomous red team and penetration testing platform",
    "url": baseUrl,
    "applicationCategory": "SecurityApplication",
    "operatingSystem": "Web-based",
    "offers": {
      "@type": "Offer",
      "price": "690",
      "priceCurrency": "USD",
      "availability": "https://schema.org/InStock"
    },
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": 4.9,
      "reviewCount": allTestimonials.length,
      "bestRating": 5,
      "worstRating": 1
    }
  },
  "publisher": {
    "@type": "Organization", 
    "name": "Nubesti",
    "url": baseUrl
  }
}));

// Aggregate Rating Schema for the service/product
const aggregateRatingSchema = {
  "@context": "https://schema.org",
  "@type": "Product",
  "@id": `${baseUrl}#cybersecurity-product`,
  "name": "Nubesti AI Red Team Platform",
  "description": "AI-powered autonomous red team operations and penetration testing platform for continuous cybersecurity assessment",
  "brand": {
    "@type": "Brand",
    "name": "Nubesti"
  },
  "category": "Cybersecurity Software",
  "image": `${baseUrl}/images/nubesti-ai-red-team-dashboard.png`,
  "url": baseUrl,
  "offers": {
    "@type": "Offer",
    "price": "690",
    "priceCurrency": "USD",
    "availability": "https://schema.org/InStock",
    "priceValidUntil": new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
    "seller": {
      "@type": "Organization",
      "name": "Nubesti",
      "url": baseUrl
    }
  },
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": 4.9,
    "reviewCount": allTestimonials.length,
    "bestRating": 5,
    "worstRating": 1,
    "ratingExplanation": "Based on customer reviews of AI-powered penetration testing effectiveness"
  },
  "review": reviewSchemas.map(review => ({
    "@type": "Review",
    "reviewBody": review.reviewBody,
    "author": review.author,
    "reviewRating": review.reviewRating,
    "datePublished": review.datePublished
  }))
};

// Customer Testimonials Collection Schema
const testimonialCollectionSchema = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "@id": `${new URL(Astro.url.pathname, Astro.site).href}#testimonials`,
  "name": "Customer Testimonials - Nubesti AI Red Team",
  "description": "Real customer experiences and success stories with Nubesti's AI-powered cybersecurity platform",
  "url": new URL(Astro.url.pathname, Astro.site).href,
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": allTestimonials.length,
    "itemListElement": reviewSchemas.map((review, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "item": {
        "@type": "Review",
        "@id": review["@id"],
        "name": `Review by ${review.author.name}`,
        "reviewBody": review.reviewBody,
        "author": review.author,
        "reviewRating": review.reviewRating
      }
    }))
  },
  "about": {
    "@type": "Service",
    "name": "AI-Powered Cybersecurity Testing",
    "provider": {
      "@type": "Organization",
      "name": "Nubesti"
    }
  }
};
---

<!-- Individual Review Schemas -->
{reviewSchemas.map((review) => (
  <script type="application/ld+json" data-schema="customer-review" set:html={JSON.stringify(review, null, 2)} />
))}

<!-- Aggregate Rating Schema -->
<script type="application/ld+json" data-schema="aggregate-rating" set:html={JSON.stringify(aggregateRatingSchema, null, 2)} />

<!-- Testimonials Collection Schema -->
<script type="application/ld+json" data-schema="testimonial-collection" set:html={JSON.stringify(testimonialCollectionSchema, null, 2)} />
